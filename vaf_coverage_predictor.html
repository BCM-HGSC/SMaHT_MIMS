<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive VAF and Coverage Plot</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.3.1/decimal.min.js"></script>
    <style>
        /* Center the content on the page */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        /* Container for sliders */
        .sliders-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .slider-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 150px;
            margin: 0 10px;
        }

        .slider-box label {
            margin-bottom: 10px;
            font-weight: bold;
        }

        input[type="range"] {
            width: 100%;
        }

        #plot {
            margin-top: 20px;
            width: 80%; /* Ensure the plot is centered and responsive */
        }
    </style>
</head>
<body>
    <h1>Interactive Plot for VAF and Coverage</h1>
    
    <!-- Container for sliders -->
    <div class="sliders-wrapper">
        <!-- VAF Slider -->
        <div class="slider-box">
            <label for="vafSlider">VAF: 
		<input type="number" id="vafValue" value="0.1" step="0.005" min="0" max="0.995">
	    </label>
            <input type="range" min="0.001" max="0.995" step="0.01" value="0.1" id="vafSlider">
        </div>

        <!-- Coverage Slider -->
        <div class="slider-box">
            <label for="coverageSlider">Coverage: 
		<input type="number" id="coverageValue", value="100" step="10", min="100" max="1000">
	    </label>
            <input type="range" min="1" max="1000" step="1" value="100" id="coverageSlider">
        </div>
    </div>

    <!-- Plot container -->
    <div id="plot"></div>
    <br/>
    <div>
	<p> This plot uses a beta-binomial distribution to plot the probability of sequencing an allele given its
	variant allele frequency (VAF) and the depth of coverage</p>
	<p> After setting your target VAF and coverage, mouse-over the plot and the y-axis number holds the probability
	any given allele will have at least that much x-axis coverage.<br/> 
	For example, at VAF=0.1 and Coverage=100, there is a 76.3% chance an allele will be supported by ≥7 reads.</br>
	Alternatively, the probability reflects the percent of alleles one can expect to be supported with ≥Min Reads.</p>
	<br/>
	<p> <a href="https://github.com/BCM-HGSC/SMaHT_VAF_Cov">Source code</a></p>
    </div>
    <script>
	// Source: https://github.com/royhzq/betajs
	Decimal.config({ precision: 17 });
	function lnBetaFunc(a, b) {
	    // Log Beta Function: ln(Beta(a, b))
	    let foo = 0.0;

	    for (let i = 0; i < a - 2; i++) {
		foo += Math.log(a - 1 - i);
	    }
	    for (let i = 0; i < b - 2; i++) {
		foo += Math.log(b - 1 - i);
	    }
	    for (let i = 0; i < a + b - 2; i++) {
		foo -= Math.log(a + b - 1 - i);
	    }
	    return foo;
	}

	function logCombinations(n, k) {
	    // Handle edge cases where binomial coefficient is 1
	    if (k === 0 || k === n) return 0;

	    // Use symmetry property C(n, k) == C(n, n-k) to minimize the number of iterations
	    if (k > n - k) k = n - k;

	    let logResult = 0;

	    // Compute the sum of logarithms for n choose k
	    for (let i = 0; i < k; i++) {
		logResult += Math.log(n - i) - Math.log(i + 1);
	    }

	    return logResult;
	}

	function logSumExp(logA, logB) {
	    if (logA === -Infinity) return logB;
	    if (logB === -Infinity) return logA;
	    const maxLog = Math.max(logA, logB);
	    return maxLog + Math.log(Math.exp(logA - maxLog) + Math.exp(logB - maxLog));
	}

	function generateData(vaf, coverage) {
	    const min_reads = [];
	    const probabilities = [];
	    let prob = 0;
	    const alpha = coverage * vaf + 1;
	    const beta = coverage * (1-vaf) + 1;
	    const beta_term2 = lnBetaFunc(alpha, beta);
	    min_reads.push(0);
	    probabilities.push(1);
	    for (let k = 0; k <= coverage; k++) {
		const binom_coeff = logCombinations(coverage, k);
		const beta_term1 = lnBetaFunc(k + alpha, coverage - k + beta);
		const beta_term = beta_term1 - beta_term2;
		const term = binom_coeff + beta_term;
		prob += Math.exp(term);

                min_reads.push(k + 1);
		let val = 1 - prob;
		if (val < 0.0) {
		    val = 0.0;
		}
                probabilities.push(val.toFixed(5));
	    }
            return { min_reads, probabilities };
	}

        // Initial values
        let vaf = 0.1;
        let coverage = 100;

        // Update the plot based on sliders
        function updatePlot() {
            const data = generateData(vaf, coverage);

            Plotly.react('plot', [{
                x: data.min_reads,
                y: data.probabilities,
                type: 'scattergl',
                mode: 'lines',
                name: 'Probability Curve',
		hovertemplate: 'Min Reads: ≥%{x}<br>Probability: %{y:.2%}<extra></extra>' // Keep original hover values
            }], {
                title: `VAF: ${vaf}, Coverage: ${coverage}`,
                xaxis: { title: 'Min Reads' },
                yaxis: { title: 'Probability' , tickformat: '.0%'}
            });
        }

        // Initialize plot
        updatePlot();

	// Event listeners for sliders
	document.getElementById('vafSlider').addEventListener('input', function () {
	    vaf = parseFloat(this.value);
	    document.getElementById('vafValue').value = vaf.toFixed(3); // Keep in sync with slider
	    updatePlot();
	});

	document.getElementById('vafValue').addEventListener('input', function () {
	    let inputValue = parseFloat(this.value);
	    if (inputValue <= 0.001) {
		inputValue = 0.001;
	    }
	    if (inputValue >= 0.995) {
		inputValue = 0.995;
	    }
	    document.getElementById('vafSlider').value = inputValue;
	    vaf = inputValue
	    updatePlot();
	});

	document.getElementById('coverageSlider').addEventListener('input', function () {
	    coverage = parseInt(this.value);
	    document.getElementById('coverageValue').value = coverage;
	    updatePlot();
	});

	document.getElementById('coverageValue').addEventListener('input', function () {
	    let inputValue = parseFloat(this.value);
	    if (inputValue < 1) {
		inputValue = 1;
	    }
	    if (inputValue > 1000) {
		inputValue = 1000;
	    }
	    coverage = inputValue;
	    document.getElementById('coverageSlider').value = inputValue;
	    updatePlot();
	});

    </script>
</body>
</html>
